<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Darts Outs Trainer — Advanced</title>

<!-- PWA manifest & icons (ensure these exist at the specified paths) -->
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/icons/icon-192.png" sizes="192x192">
<link rel="icon" href="/icons/icon-512.png" sizes="512x512">
<link rel="apple-touch-icon" href="/icons/icon-192.png">
<meta name="theme-color" content="#121212">

<style>
  :root{
    --bg: #071021;
    --card: #0b1220;
    --accent: #ffd166;
    --muted: #94a3b8;
    --white: #e6eef8;
    --success: #16a34a;
    --danger: #ef4444;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#071021,#07142a);color:var(--white)}
  .app{max-width:1100px;margin:18px auto;padding:14px}
  header{display:flex;align-items:center;gap:12px}
  h1{margin:0;font-size:20px}
  .top-actions{margin-left:auto;display:flex;gap:8px;align-items:center}
  .btn{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
  .muted{color:var(--muted);font-size:13px}
  .layout{display:grid;grid-template-columns:420px 1fr;gap:16px;margin-top:14px}
  .card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 24px rgba(2,6,23,0.6)}
  .board-wrap{display:flex;flex-direction:column;gap:8px;align-items:center}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  input[type=number]{width:90px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  select{padding:6px;border-radius:6px;border:none;background:rgba(255,255,255,0.04);color:inherit}
  #board-svg{width:360px;height:360px;display:block}
  .log{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;color:var(--muted);min-height:88px;white-space:pre-wrap}
  .selection{font-weight:700;margin-top:6px}
  .small{font-size:13px;color:var(--muted)}
  .highlight{filter:drop-shadow(0 6px 18px rgba(255,209,102,0.14));transform:scale(1.05);transition:all .18s}
  .fade{opacity:.38;transition:opacity .18s}
  .stats-row{display:flex;gap:12px;align-items:center;margin-top:8px}
  .chip{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:10px}
  footer{margin-top:12px;color:var(--muted);font-size:13px}
  /* Responsive */
  @media(max-width:980px){.layout{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Darts Outs Trainer — Advanced</h1>
      <div class="top-actions">
        <nav>
          <button class="btn" data-route="#trainer">Trainer</button>
          <button class="btn" data-route="#stats">Stats</button>
          <button class="btn" data-route="#settings">Settings</button>
        </nav>
        <div class="muted">Practice checkouts — finish on a double</div>
      </div>
    </header>

    <div id="content" class="layout">
      <!-- Left: Board + controls -->
      <div class="card" id="trainer-pane">
        <div style="display:flex;align-items:center;gap:8px;justify-content:space-between">
          <div>
            <div class="small">Start (max)</div>
            <input id="startScore" type="number" min="2" max="501" value="170">
          </div>

          <div style="display:flex;gap:6px">
            <button id="newBtn" class="btn">New Target</button>
            <button id="revealBtn" class="btn">Reveal Out(s)</button>
            <button id="checkBtn" class="btn">Check My Route</button>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;align-items:center;gap:12px;justify-content:center">
          <div style="text-align:center">
            <div style="font-size:48px;font-weight:800" id="targetDisplay">—</div>
            <div class="small">Remaining: <span id="remaining">—</span></div>
          </div>
        </div>

        <div class="board-wrap" style="margin-top:12px">
          <!-- SVG dartboard (interactive) -->
          <svg id="board-svg" viewBox="0 0 360 360" role="img" aria-label="Interactive dartboard">
            <!-- We'll programmatically insert wedges with JS -->
            <defs>
              <filter id="glow"><feDropShadow dx="0" dy="6" stdDeviation="8" flood-color="#ffd166" flood-opacity="0.14"/></filter>
            </defs>
            <g id="board-group" transform="translate(180,180)"></g>
          </svg>

          <div style="display:flex;gap:8px;margin-top:6px">
            <div id="sbull" class="chip" style="cursor:pointer">SB (25)</div>
            <div id="dbull" class="chip" style="cursor:pointer">DB (50)</div>
            <div id="miss" class="chip" style="cursor:pointer">Miss</div>
          </div>

          <div style="width:100%;margin-top:8px">
            <div style="font-weight:700">Your selection</div>
            <div id="selection" class="log">(no darts yet)</div>
            <div style="display:flex;gap:8px;margin-top:6px">
              <button id="undoBtn" class="btn">Undo</button>
              <button id="clearBtn" class="btn">Clear</button>
            </div>
          </div>

          <div style="width:100%;margin-top:8px">
            <div style="font-weight:700">Standard suggested out(s)</div>
            <div id="standardOut" class="log">(press Reveal)</div>
          </div>
        </div>

      </div>

      <!-- Right: Info / Settings / Stats -->
      <div class="card" id="side-pane">
        <div id="trainer-info">
          <h3 style="margin-top:0">How to use</h3>
          <ol style="color:var(--muted)">
            <li>Click <strong>New Target</strong> to generate a checkout (2–170).</li>
            <li>Click wedges (single/triple/double) or SB/DB/Miss to propose your checkout route (up to 3 darts).</li>
            <li>Press <strong>Check My Route</strong> to compare with standard suggestions.</li>
          </ol>

          <div class="stats-row">
            <div class="chip">Attempts: <span id="stat-attempts">0</span></div>
            <div class="chip">Correct: <span id="stat-correct">0</span></div>
            <div class="chip">Accuracy: <span id="stat-accuracy">0%</span></div>
          </div>

          <div style="margin-top:10px">
            <h4>Quick tips</h4>
            <ul style="color:var(--muted)">
              <li>Finish must be exactly 0 and last dart a double (DB counts as double).</li>
              <li>If you go below 2, it's a bust — the trainer logs that.</li>
              <li>Use the Settings tab to toggle sounds and strategy.</li>
            </ul>
          </div>
        </div>

        <!-- Stats page -->
        <div id="stats-pane" style="display:none">
          <h3 style="margin-top:0">Session History</h3>
          <div id="attempt-list" class="log"></div>
          <div style="margin-top:8px">
            <button id="clearStatsBtn" class="btn">Clear Stats</button>
          </div>
        </div>

        <!-- Settings page -->
        <div id="settings-pane" style="display:none">
          <h3 style="margin-top:0">Settings</h3>
          <div style="display:flex;flex-direction:column;gap:8px">
            <label>Strategy:
              <select id="strategy">
                <option value="standard">Standard</option>
                <option value="bull-first">Bull-first</option>
                <option value="treble-first">Treble-first</option>
              </select>
            </label>

            <label>Sounds:
              <select id="soundToggle">
                <option value="on">On</option>
                <option value="off">Off</option>
              </select>
            </label>

            <label>Show remaining inline:
              <select id="showRemaining">
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
            </label>

            <div style="display:flex;gap:8px">
              <button id="saveSettingsBtn" class="btn">Save Settings</button>
              <button id="resetSettingsBtn" class="btn">Reset to Defaults</button>
            </div>
          </div>
        </div>

        <footer>
          Built as an advanced PWA trainer. Icons & service worker should be present in repo root.
        </footer>
      </div>
    </div>
  </div>

<script>
/* -----------------------
   CORE DATA & SETUP
   ----------------------- */

// Board order clockwise starting at 20 (standard)
const ORDER = [20,1,18,4,13,6,10,15,2,17,3,19,7,16,8,11,14,9,12,5];

// Precomputed throws (for lookup)
const THROW_DEFS = [];
ORDER.forEach(n => { THROW_DEFS.push({name:'S'+n,value:n,isDouble:false}); });
ORDER.forEach(n => { THROW_DEFS.push({name:'T'+n,value:3*n,isDouble:false}); });
ORDER.forEach(n => { THROW_DEFS.push({name:'D'+n,value:2*n,isDouble:true}); });
THROW_DEFS.push({name:'SB',value:25,isDouble:false});
THROW_DEFS.push({name:'DB',value:50,isDouble:true});

// Standard checkouts — expanded (some entries have multiple options)
const STANDARD_OUTS = {
  170:[['T20','T20','DB']],167:[['T20','T19','DB']],164:[['T20','T18','DB']],161:[['T20','T17','DB']],160:[['T20','T20','D20']],
  158:[['T20','T20','D19']],157:[['T20','T19','D20']],156:[['T20','T20','D18']],155:[['T20','T19','D19']],154:[['T20','T18','D20']],
  153:[['T20','T19','D18']],152:[['T20','T20','D16']],151:[['T20','T17','D20']],150:[['T20','T20','D15']],149:[['T20','T19','D16']],
  148:[['T20','T16','D20']],147:[['T20','T17','D18']],146:[['T20','T18','D16']],145:[['T20','T15','D20']],144:[['T20','T20','D12']],
  143:[['T20','T17','D16']],142:[['T20','T14','D20']],141:[['T20','T19','D12']],140:[['T20','T20','D10']],139:[['T20','T13','D20']],
  138:[['T20','T18','D12']],137:[['T20','T19','D10']],136:[['T20','T20','D8']],135:[['T20','T17','D12']],134:[['T20','T14','D16']],
  133:[['T20','T19','D8']],132:[['T20','T16','D12']],131:[['T20','T13','D16']],130:[['T20','T18','D8']],129:[['T19','T16','D12']],
  128:[['T18','T14','D16']],127:[['T20','T17','D8']],126:[['T19','T19','D6']],125:[['T20','T15','D10']],124:[['T20','T16','D8']],
  123:[['T19','T16','D9']],122:[['T18','T20','D4']],121:[['T20','T11','D14']],120:[['T20','20','D20']],119:[['T19','T10','D16']],
  118:[['T20','T18','D2']],117:[['T20','T19','D?']],116:[['T20','T20','D8']],115:[['T20','T15','D10']],114:[['T20','T14','D12']],
  113:[['T20','T13','D12']],112:[['T20','T12','D16']],111:[['T20','T17','D5']],110:[['T20','T10','D20']],109:[['T20','T19','D?']],
  // More common 2-dart and 1-dart finishes added
  100:[['T20','D20']], 80:[['T16','D16']], 50:[['DB']], 40:[['D20']], 32:[['D16']], 20:[['D10']], 60:[['20','D20']],
  58:[['20','D19']],54:[['18','D18']],36:[['D18']],52:[['20','D16']],46:[['14','D16']],34:[['D17']],16:[['D8']],
  8:[['D4']],4:[['D2']],2:[['D1']]
};

// Simple utility to compute fallback outs (1-3 darts) that end on a double.
function computeOuts(target) {
  const candidates = THROW_DEFS.slice();
  const outs = [];
  // 1-dart
  for (const a of candidates) { if (a.value === target && a.isDouble) outs.push([a.name]); }
  // 2-dart
  for (const a of candidates) {
    for (const b of candidates) {
      if (a.value + b.value === target && b.isDouble) outs.push([a.name, b.name]);
    }
  }
  // 3-dart
  for (const a of candidates) {
    for (const b of candidates) {
      for (const c of candidates) {
        if (a.value + b.value + c.value === target && c.isDouble) outs.push([a.name, b.name, c.name]);
      }
    }
  }
  // unique and sorted by length
  const uniq = new Map();
  const formatted = [];
  for (const combo of outs) {
    const key = combo.join(',');
    if (!uniq.has(key)) { uniq.set(key, true); formatted.push(combo); }
  }
  formatted.sort((a,b)=>a.length-b.length);
  return formatted;
}

/* -----------------------
   STATE
   ----------------------- */
let state = {
  target: null,
  remaining: null,
  selection: [], // array of {name, value, isDouble}
  lastRoutes: [], // last shown standard routes (array of arrays)
  stats: loadStats(),
  settings: loadSettings()
};

/* -----------------------
   PERSISTENCE
   ----------------------- */
function loadStats() {
  try {
    return JSON.parse(localStorage.getItem('darts_stats_v2')) || {attempts:0,correct:0,history:[]};
  } catch(e){ return {attempts:0,correct:0,history:[]}; }
}
function saveStats() { localStorage.setItem('darts_stats_v2', JSON.stringify(state.stats)); updateStatsUI(); }

function loadSettings() {
  try {
    const s = JSON.parse(localStorage.getItem('darts_settings_v1'));
    if (s) return s;
  } catch(e){}
  const defaults = {strategy:'standard', sound:'on', showRemaining:true};
  localStorage.setItem('darts_settings_v1', JSON.stringify(defaults));
  return defaults;
}
function saveSettings() { localStorage.setItem('darts_settings_v1', JSON.stringify(state.settings)); }

/* -----------------------
   UI ELEMENTS
   ----------------------- */
const targetDisplay = document.getElementById('targetDisplay');
const remainingEl = document.getElementById('remaining');
const selectionEl = document.getElementById('selection');
const standardOutEl = document.getElementById('standardOut');
const gamelog = document.getElementById('trainer-pane').querySelector('.log') || document.getElementById('selection');
const statAttemptsEl = document.getElementById('stat-attempts');
const statCorrectEl = document.getElementById('stat-correct');
const statAccuracyEl = document.getElementById('stat-accuracy');
const attemptList = document.getElementById('attempt-list');

/* -----------------------
   AUDIO (WebAudio tiny tones)
   ----------------------- */
const audioCtx = (typeof AudioContext !== 'undefined') ? new AudioContext() : null;
function beep(freq=880, time=0.08, type='sine', vol=0.08) {
  if (!audioCtx) return;
  if (state.settings.sound === 'off') return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type;
  o.frequency.value = freq;
  g.gain.value = vol;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + time);
}

/* -----------------------
   BOARD RENDERING (SVG)
   ----------------------- */
const boardGroup = document.getElementById('board-group');
const RADIUS = 160;
function buildBoardSVG() {
  boardGroup.innerHTML = ''; // clear
  const wedges = ORDER.length;
  const outer = RADIUS;
  const ringWidth = Math.round(outer*0.12);
  const inn = Math.round(outer*0.42); // inner single area radius
  const tripleOut = Math.round(inn + ringWidth);
  const tripleIn = Math.round(inn - ringWidth);
  const doubleOut = Math.round(outer);
  const doubleIn = Math.round(outer - ringWidth);

  for (let i=0;i<wedges;i++){
    const angleA = (i/wedges)*360 - 90;
    const angleB = ((i+1)/wedges)*360 - 90;
    const midAngle = (angleA+angleB)/2;
    const num = ORDER[i];

    // DOUBLE wedge (outer)
    const doublePath = makeArc(doubleIn,doubleOut,angleA,angleB);
    const doubleEl = createSegment(doublePath, (i%2===0) ? '#d62e2e' : '#1f8f3a', `D${num}`, 2*num, true);
    boardGroup.appendChild(doubleEl);

    // Single outer (between double and triple)
    const singleOuterPath = makeArc(tripleOut,doubleIn,angleA,angleB);
    const singleOutEl = createSegment(singleOuterPath, (i%2===0)?'#f3f3f3':'#1f1f1f', `S${num}`, num, false);
    boardGroup.appendChild(singleOutEl);

    // Triple wedge
    const triplePath = makeArc(tripleIn,tripleOut,angleA,angleB);
    const tripleEl = createSegment(triplePath, (i%2===0)?'#d62e2e':'#1f8f3a', `T${num}`, 3*num, false);
    boardGroup.appendChild(tripleEl);

    // Single inner (between triple and bull)
    const singleInnerPath = makeArc(6,tripleIn,angleA,angleB);
    const singleInEl = createSegment(singleInnerPath, (i%2===0)?'#f3f3f3':'#1f1f1f', `S${num}`, num, false);
    boardGroup.appendChild(singleInEl);
  }

  // DB ring and SB circle in center
  // small DB circle
  const dbCircle = document.createElementNS('http://www.w3.org/2000/svg','circle');
  dbCircle.setAttribute('r', 10);
  dbCircle.setAttribute('cx', 0);
  dbCircle.setAttribute('cy', 0);
  dbCircle.setAttribute('fill', '#d62e2e');
  dbCircle.setAttribute('data-name','DB');
  dbCircle.style.cursor='pointer';
  dbCircle.addEventListener('click',()=>pickThrow('DB',50,true));
  boardGroup.appendChild(dbCircle);

  const sbCircle = document.createElementNS('http://www.w3.org/2000/svg','circle');
  sbCircle.setAttribute('r', 18);
  sbCircle.setAttribute('cx', 0);
  sbCircle.setAttribute('cy', 0);
  sbCircle.setAttribute('fill', '#1f8f3a');
  sbCircle.setAttribute('data-name','SB');
  sbCircle.style.cursor='pointer';
  sbCircle.addEventListener('click',()=>pickThrow('SB',25,false));
  boardGroup.appendChild(sbCircle);
}

function makeArc(rIn, rOut, angA, angB){
  // returns SVG path for wedge between rIn and rOut from angA->angB (angles in degrees)
  const a1 = toRad(angA), a2 = toRad(angB);
  const x1 = Math.cos(a1)*rOut, y1 = Math.sin(a1)*rOut;
  const x2 = Math.cos(a2)*rOut, y2 = Math.sin(a2)*rOut;
  const x3 = Math.cos(a2)*rIn,  y3 = Math.sin(a2)*rIn;
  const x4 = Math.cos(a1)*rIn,  y4 = Math.sin(a1)*rIn;
  const large = (angB-angA>180)?1:0;
  const path = `M ${x1} ${y1} A ${rOut} ${rOut} 0 ${large} 1 ${x2} ${y2} L ${x3} ${y3} A ${rIn} ${rIn} 0 ${large} 0 ${x4} ${y4} Z`;
  return path;
}
function createSegment(d,color,name,value,isDouble){
  const ns = 'http://www.w3.org/2000/svg';
  const g = document.createElementNS(ns,'path');
  g.setAttribute('d', d);
  g.setAttribute('fill', color);
  g.setAttribute('stroke', '#0b1220');
  g.setAttribute('stroke-width', 0.8);
  g.setAttribute('data-name', name);
  g.setAttribute('data-value', value);
  g.setAttribute('data-isdouble', isDouble? '1':'0');
  g.style.cursor='pointer';
  g.addEventListener('click', (e)=>{ pickThrow(name, parseInt(value), !!isDouble); });
  // hover highlight
  g.addEventListener('mouseenter', ()=>{ g.style.opacity=0.86; });
  g.addEventListener('mouseleave', ()=>{ g.style.opacity=1; });
  return g;
}
function toRad(a){ return a * Math.PI / 180; }

/* -----------------------
   GAME LOGIC
   ----------------------- */
function newTarget(){
  const max = Math.min(parseInt(document.getElementById('startScore').value)||170,170);
  const min = 2;
  const val = Math.floor(Math.random()*(max-min+1))+min;
  state.target = val; state.remaining = val; state.selection = []; state.lastRoutes = [];
  updateUI();
  appendLog(`New target: ${val}`);
  beep(880,0.05);
}
function pickThrow(name,value,isDouble){
  if (state.target === null) { alert('Press New Target'); return; }
  if (state.selection.length >= 3) { alert('You already selected 3 darts'); return; }
  state.selection.push({name,value,isDouble});
  state.remaining -= value;
  updateUI();
  // optional auto-check if reached 0
  if (state.selection.length > 0 && state.remaining <= 0) {
    // don't auto-bust here — let user check
  }
  beep(600,0.04);
}
function undo(){ if (!state.selection.length) return; const last = state.selection.pop(); state.remaining += last.value; updateUI(); beep(520,0.03); }
function clearSelection(){ state.selection=[]; state.remaining = state.target; updateUI(); beep(420,0.03); }

function updateUI(){
  targetDisplay.textContent = state.target === null ? '—' : state.target;
  remainingEl.textContent = state.remaining === null ? '—' : Math.max(0,state.remaining);
  if (state.selection.length === 0) selectionEl.textContent = '(no darts yet)';
  else {
    const lines = state.selection.map((s,i) => `${i+1}. ${s.name} (${s.value}) — rem: ${Math.max(0, state.target - state.selection.slice(0,i+1).reduce((a,b)=>a+b.value,0))}`);
    selectionEl.textContent = lines.join('\n');
  }
  // update stats UI
  updateStatsUI();
  // clear highlights
  clearHighlights();
}

function revealStandard(){
  if(state.target === null){ alert('Press New Target'); return; }
  let routes = STANDARD_OUTS[state.target] ? STANDARD_OUTS[state.target].slice() : null;
  if(!routes) routes = computeOuts(state.target);
  // filter by strategy
  const strat = state.settings.strategy || 'standard';
  if (strat === 'bull-first') {
    routes = routes.filter(r => r[0] === 'SB' || r[0] === 'DB' || !/^T/.test(r[0]));
    if (!routes.length) routes = computeOuts(state.target);
  }
  if (strat === 'treble-first') {
    routes = routes.filter(r => /^T/.test(r[0]));
    if(!routes.length) routes = computeOuts(state.target).filter(r=>/^T/.test(r[0]));
    if(!routes.length) routes = computeOuts(state.target);
  }
  state.lastRoutes = routes.slice(0,4);
  if(!state.lastRoutes.length) standardOutEl.innerHTML = '(no standard outs found)';
  else {
    standardOutEl.innerHTML = state.lastRoutes.map((r,idx) =>
      `<div style="padding:6px;border-radius:6px;background:rgba(255,255,255,0.01);margin-bottom:6px;">
         <strong>Option ${idx+1}:</strong> ${r.join(', ')} <button data-idx="${idx}" class="btn show-route">Show on board</button>
       </div>`
    ).join('');
    // attach listeners to buttons
    document.querySelectorAll('.show-route').forEach(b => b.addEventListener('click',(ev)=>{ highlightRoute(parseInt(ev.target.dataset.idx)); }));
  }
  beep(1040,0.06);
}

function highlightRoute(idx){
  const r = state.lastRoutes[idx]; if(!r) return;
  clearHighlights();
  // map names to elements
  for (const name of r){
    const el = document.querySelector(`[data-name="${name}"]`);
    if(el){ el.classList.add('highlight'); }
  }
  // fade others
  document.querySelectorAll('.seg-fake').forEach(()=>{}); // not used
  document.querySelectorAll('[data-name]').forEach(el => { if(!el.classList.contains('highlight')) el.classList.add('fade'); });
  beep(1000,0.08);
}

function clearHighlights(){
  document.querySelectorAll('.highlight').forEach(e=>e.classList.remove('highlight'));
  document.querySelectorAll('.fade').forEach(e=>e.classList.remove('fade'));
}

/* -----------------------
   CHECKING & FEEDBACK
   ----------------------- */
function checkRoute(){
  if (state.target === null){ alert('Press New Target'); return; }
  const chosen = state.selection.map(s=>s.name);
  // get possible routes
  let routes = STANDARD_OUTS[state.target] ? STANDARD_OUTS[state.target].map(r => r.slice()) : computeOuts(state.target).slice(0,10);
  // normalize: some standard entries contain numeric '20' or similar; convert to S20 when needed
  routes = routes.map(route => route.map(item => normalizeName(item)));
  const chosenStr = chosen.join(',');
  const match = routes.find(r => r.join(',') === chosenStr);
  if (match){
    appendLog(`Exact match: ${chosenStr}`);
    beep(1200,0.08,'square');
    state.stats.attempts++; state.stats.correct++; state.stats.history.unshift({t:Date.now(),target:state.target,choice:chosen,ok:true});
    if(state.stats.history.length>50) state.stats.history.pop();
    saveStats();
    alert('Exact match — great!');
    highlightNames(match);
    return;
  }
  // check legal finish: sum == target and last is double
  const sum = state.selection.reduce((a,b)=>a+b.value,0);
  if (sum === state.target) {
    const last = state.selection[state.selection.length-1];
    if (last && last.isDouble) {
      appendLog(`Legal finish but different from main route: ${chosenStr}`);
      beep(880,0.08);
      state.stats.attempts++; state.stats.history.unshift({t:Date.now(),target:state.target,choice:chosen,ok:false,reason:'legal-different'});
      if(state.stats.history.length>50) state.stats.history.pop();
      saveStats();
      alert('Legal finish but differs from primary suggested route.');
      // show best suggestion
      if (routes.length) highlightNames(routes[0]);
      return;
    } else {
      appendLog(`Invalid finish (not on double): ${chosenStr}`);
      beep(300,0.08);
      alert('You reached 0 but final dart was not a double — invalid finish.');
      state.stats.attempts++; state.stats.history.unshift({t:Date.now(),target:state.target,choice:chosen,ok:false,reason:'not-double'});
      if(state.stats.history.length>50) state.stats.history.pop();
      saveStats();
      return;
    }
  }
  // not matching
  appendLog(`No match for ${chosenStr}. See suggestions.`);
  beep(480,0.08);
  state.stats.attempts++; state.stats.history.unshift({t:Date.now(),target:state.target,choice:chosen,ok:false,reason:'no-match'});
  if(state.stats.history.length>50) state.stats.history.pop();
  saveStats();
  revealStandard();
}

/* Helper to normalize entries like "20" to "S20" if necessary */
function normalizeName(n){
  if(!n) return n;
  if(n === 'DB' || n === 'SB') return n;
  if(/^[0-9]+$/.test(n)) return 'S'+n;
  return n;
}

/* Highlight names on board */
function highlightNames(route){
  clearHighlights();
  for (const name of route) {
    const n = normalizeName(name);
    const el = document.querySelector(`[data-name="${n}"]`);
    if(el) el.classList.add('highlight');
  }
  document.querySelectorAll('[data-name]').forEach(el => { if(!el.classList.contains('highlight')) el.classList.add('fade'); });
}

/* -----------------------
   LOG & STATS UI
   ----------------------- */
function appendLog(msg){
  const ts = new Date().toLocaleTimeString();
  const area = document.getElementById('selection');
  area.textContent = `${msg}\n` + (area.textContent || '');
  // also update attempt list succinctly
  renderHistory();
}
function updateStatsUI(){
  statAttemptsEl.textContent = state.stats.attempts || 0;
  statCorrectEl.textContent = state.stats.correct || 0;
  const acc = state.stats.attempts ? Math.round((state.stats.correct||0)/state.stats.attempts*100) : 0;
  statAccuracyEl.textContent = acc + '%';
  renderHistory();
}
function renderHistory(){
  const max = 30;
  attemptList.innerHTML = state.stats.history.length ? state.stats.history.slice(0,max).map(h=>{
    const d = new Date(h.t);
    return `<div style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.02)">${d.toLocaleString()} — target ${h.target} — choice: ${h.choice.join(', ')} — ${h.ok?'<strong style="color:#7ee787">OK</strong>':'<span style="color:#ffb3b3">No</span>'}</div>`;
  }).join('') : '(no attempts yet)';
}

/* -----------------------
   SETTINGS UI
   ----------------------- */
document.getElementById('saveSettingsBtn').addEventListener('click',()=>{
  state.settings.strategy = document.getElementById('strategy').value;
  state.settings.sound = document.getElementById('soundToggle').value;
  state.settings.showRemaining = document.getElementById('showRemaining').value === 'yes';
  saveSettings(); alert('Settings saved'); beep(880,0.06);
});
document.getElementById('resetSettingsBtn').addEventListener('click',()=>{
  state.settings = {strategy:'standard', sound:'on', showRemaining:true};
  populateSettingsUI();
  saveSettings(); alert('Settings reset'); beep(400,0.06);
});
function populateSettingsUI(){
  document.getElementById('strategy').value = state.settings.strategy || 'standard';
  document.getElementById('soundToggle').value = state.settings.sound || 'on';
  document.getElementById('showRemaining').value = state.settings.showRemaining ? 'yes' : 'no';
}

/* -----------------------
   ROUTING (simple hash)
   ----------------------- */
function showPane(route){
  document.getElementById('trainer-info').style.display = route === '#trainer' ? 'block' : 'none';
  document.getElementById('trainer-pane').style.display = route === '#trainer' ? 'block' : 'block';
  document.getElementById('stats-pane').style.display = route === '#stats' ? 'block' : 'none';
  document.getElementById('settings-pane').style.display = route === '#settings' ? 'block' : 'none';
}
window.addEventListener('hashchange', ()=>{ showPane(location.hash || '#trainer'); });
document.querySelectorAll('button[data-route]').forEach(b => b.addEventListener('click', e => { location.hash = e.currentTarget.dataset.route; }));
/* -----------------------
   WIRING CONTROLS
   ----------------------- */
document.getElementById('newBtn').addEventListener('click', newTarget);
document.getElementById('revealBtn').addEventListener('click', revealStandard);
document.getElementById('checkBtn').addEventListener('click', checkRoute);
document.getElementById('undoBtn').addEventListener('click', undo);
document.getElementById('clearBtn').addEventListener('click', clearSelection);
document.getElementById('clearStatsBtn').addEventListener('click', ()=>{ if(confirm('Clear stats?')){ state.stats = {attempts:0,correct:0,history:[]}; saveStats(); renderHistory(); } });

/* -----------------------
   SAVE STATS
   ----------------------- */
function saveStats(){
  localStorage.setItem('darts_stats_v2', JSON.stringify(state.stats));
  updateStatsUI();
}

/* -----------------------
   STARTUP
   ----------------------- */
(function init(){
  buildBoardSVG();
  populateSettingsUI();
  updateUI();
  showPane(location.hash || '#trainer');
  // load recent history into UI
  renderHistory();
  // register service worker if available & not already registered
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js').catch(e=>console.log('SW reg fail',e));
  }
  // attach SB/DB/Miss chips
  document.getElementById('sbull').addEventListener('click',()=>pickThrow('SB',25,false));
  document.getElementById('dbull').addEventListener('click',()=>pickThrow('DB',50,true));
  document.getElementById('miss').addEventListener('click',()=>pickThrow('Miss',0,false));
})();
</script>

</body>
</html>
